<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لعبة الكرة — مباشر</title>
<style>
  :root{--bg:#0b1220;--panel:rgba(0,0,0,0.45);--ui:#fff}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial}
  body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071022,#0b1220);color:var(--ui);padding:12px}
  .wrap{width:900px;max-width:100%;background:var(--panel);border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  header{padding:12px 16px;display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  .game-area{background:#000; display:flex; gap:12px; padding:12px;flex-wrap:wrap}
  canvas{background:#000;border-radius:8px;display:block;width:780px;height:450px;max-width:100%}
  .controls{width:260px; color:#ddd; font-size:14px}
  .btn{display:inline-block;padding:8px 10px;border-radius:8px;background:#1f6feb;color:#fff;border:none;cursor:pointer;margin:6px 0}
  .small{font-size:13px;color:#ccc;margin-top:8px}
  .touch-row{display:flex;gap:6px;margin-top:10px}
  .touch-btn{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.06);text-align:center;user-select:none}
  .hud{margin-top:8px;font-weight:600}
  footer{padding:12px 16px;color:#9aa; font-size:13px}
  @media(max-width:820px){
    .game-area{flex-direction:column;align-items:center}
    .controls{width:100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>لعبة الكرة — جمع العملات للقفز عبر المستويات</h1>
    <div style="margin-left:auto;font-size:13px;color:#cde">ميزات: 3 مستويات • كل عملة = 10 نقاط • 100 نقطة للتقدم</div>
  </header>

  <div class="game-area">
    <canvas id="game" width="780" height="450"></canvas>
    <div class="controls">
      <button id="playBtn" class="btn">تشغيل</button>
      <button id="restartBtn" class="btn" style="background:#16a34a">إعادة الآن</button>
      <div class="small">التحكم:</div>
      <div class="small">← → أو A/D للحركة • Space للقفز</div>
      <div class="small hud" id="hud">المستوى: 1 / 3<br>النقاط: 0 / 100</div>

      <div class="small" style="margin-top:12px">لمس (للأجهزة):</div>
      <div class="touch-row">
        <div class="touch-btn" id="tLeft">◀</div>
        <div class="touch-btn" id="tJump">▲</div>
        <div class="touch-btn" id="tRight">▶</div>
      </div>

      <div class="small" style="margin-top:10px;color:#bcd">عند إنهاء المستوى 3 تعاد اللعبة تلقائياً بعد 3 ثواني.</div>
    </div>
  </div>

  <footer>ملف HTML واحد — يمكنك فتحه مباشرة في المتصفح أو رفعه لموقع استضافة ثابتة.</footer>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const hudEl = document.getElementById('hud');
  const playBtn = document.getElementById('playBtn');
  const restartBtn = document.getElementById('restartBtn');
  let running = false;

  // فيزيا
  const gravity = 0.9;
  const friction = 0.9;

  let level = 1;
  let score = 0;
  let finished = false;

  const groundY = h - 40;

  const ball = { x: 100, y: groundY - 18, r: 18, vx: 0, vy: 0, speed: 3.4, onGround: true };

  let coins = [];

  function spawnCoin(lv){
    const margin=40;
    const x = Math.random()*(w-margin*2)+margin;
    const y = groundY - Math.random()*(140+lv*40)-10;
    coins.push({x,y,r:10,collected:false});
  }

  function initCoinsForLevel(lv){
    coins = [];
    for(let i=0;i<6+lv;i++) spawnCoin(lv);
  }

  initCoinsForLevel(1);

  // إدخال
  const keys = {left:false,right:false,up:false};
  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
    if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
    if(e.key===' '||e.key==='ArrowUp'||e.key==='w') keys.up=true;
    if(e.key==='p') toggleRun();
  });
  window.addEventListener('keyup', e=>{
    if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
    if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
    if(e.key===' '||e.key==='ArrowUp'||e.key==='w') keys.up=false;
  });

  // لمس
  const tLeft = document.getElementById('tLeft');
  const tRight = document.getElementById('tRight');
  const tJump = document.getElementById('tJump');
  tLeft.addEventListener('touchstart', e=>{e.preventDefault(); keys.left=true});
  tLeft.addEventListener('touchend', e=>{e.preventDefault(); keys.left=false});
  tRight.addEventListener('touchstart', e=>{e.preventDefault(); keys.right=true});
  tRight.addEventListener('touchend', e=>{e.preventDefault(); keys.right=false});
  tJump.addEventListener('touchstart', e=>{e.preventDefault(); keys.up=true});
  tJump.addEventListener('touchend', e=>{e.preventDefault(); keys.up=false});

  function drawBackground(lv){
    if(lv===1){
      const g=ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,'#9be7ff'); g.addColorStop(1,'#dff7ff'); ctx.fillStyle=g;
      ctx.fillRect(0,0,w,h);
      // شمس
      ctx.beginPath(); ctx.arc(w-100,80,40,0,Math.PI*2); ctx.fillStyle='rgba(255,230,120,0.95)'; ctx.fill();
    } else if(lv===2){
      const g=ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,'#ffd89b'); g.addColorStop(1,'#19547b'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
      // جبل
      ctx.fillStyle='#3b3b58'; ctx.beginPath(); ctx.moveTo(0,groundY); ctx.lineTo(120,220); ctx.lineTo(260,groundY); ctx.fill();
    } else {
      const g=ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,'#0f2027'); g.addColorStop(1,'#203a43'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
      // مباني
      for(let i=0;i<6;i++){
        const bw=40+(i%3)*15,bx=i*120+30,bh=120+((i*37)%90);
        ctx.fillStyle=`rgba(${30+i*20},${50+i*30},${100+i*15},0.9)`; ctx.fillRect(bx,groundY-bh,bw,bh);
      }
    }
  }

  function drawGround(){ ctx.fillStyle='#2f2f2f'; ctx.fillRect(0,groundY,w,h-groundY); }

  function drawBall(){
    // shadow
    ctx.beginPath(); ctx.ellipse(ball.x+8, groundY+6, ball.r*0.9, ball.r*0.4,0,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.fill();
    // ball
    ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    const grad = ctx.createRadialGradient(ball.x-6,ball.y-8,2,ball.x,ball.y,ball.r);
    if(level===1){grad.addColorStop(0,'#fff');grad.addColorStop(1,'#ff6b6b')}
    else if(level===2){grad.addColorStop(0,'#fff');grad.addColorStop(1,'#ffd166')}
    else {grad.addColorStop(0,'#fff');grad.addColorStop(1,'#80ffd4')}
    ctx.fillStyle=grad; ctx.fill();
  }

  function drawCoin(c){
    if(c.collected) return;
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fillStyle='gold'; ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.stroke();
  }

  function update(dt){
    // horizontal
    if(keys.left) ball.vx = -ball.speed;
    else if(keys.right) ball.vx = ball.speed;
    else ball.vx *= friction;

    if((keys.up) && ball.onGround){
      ball.vy = -14 - level; ball.onGround = false;
    }

    ball.vy += gravity * (dt/16);
    ball.x += ball.vx * (dt/16);
    ball.y += ball.vy * (dt/16);

    if(ball.y + ball.r > groundY){ ball.y = groundY - ball.r; ball.vy = 0; ball.onGround = true; }

    if(ball.x - ball.r < 0) ball.x = ball.r;
    if(ball.x + ball.r > w) ball.x = w - ball.r;

    coins.forEach(c=>{
      if(c.collected) return;
      const dx = c.x - ball.x, dy = c.y - ball.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < c.r + ball.r - 2){
        c.collected = true;
        score += 10;
        updateHUD();
      }
    });

    if(coins.filter(c=>!c.collected).length < 3){
      for(let i=0;i<3+level;i++) spawnCoin(level);
    }
  }

  function render(){
    drawBackground(level);
    drawGround();
    coins.forEach(drawCoin);
    drawBall();
  }

  function updateHUD(){
    hudEl.innerHTML = `المستوى: ${level} / 3<br>النقاط: ${score} / 100`;
  }

  let last = performance.now();
  function loop(now){
    const dt = now - last; last = now;
    update(dt); render();

    // تحقق من تقدم المستوى
    if(score >= 100 && !finished){
      if(level < 3){
        finished = true;
        showMessage('تهانينا! تنتقل للمستوى التالي...');
        setTimeout(()=> {
          level++; score = 0; initCoinsForLevel(level); updateHUD(); finished = false; hideMessage();
        }, 900);
      } else {
        finished = true;
        showMessage('انتهت اللعبة! سيتم إعادة التشغيل تلقائياً...');
        setTimeout(()=> {
          // إعادة تهيئة
          level = 1; score = 0; initCoinsForLevel(1); updateHUD(); finished = false; hideMessage();
        }, 3000);
      }
    }

    if(running) requestAnimationFrame(loop);
  }

  // رسالة صغيرة HUD داخل الـ canvas (نستعمل عنصر DOM خارجي بسيط باستخدام alert-like)
  function showMessage(txt){
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(w/2-160,40,320,40);
    ctx.fillStyle='white'; ctx.textAlign='center'; ctx.font='18px Arial'; ctx.fillText(txt, w/2, 68);
    ctx.restore();
    playBtn.textContent = 'إيقاف';
  }
  function hideMessage(){ playBtn.textContent = running?'إيقاف':'تشغيل'; }

  function toggleRun(){
    running = !running;
    playBtn.textContent = running? 'إيقاف' : 'تشغيل';
    if(running){ last = performance.now(); requestAnimationFrame(loop); }
  }

  playBtn.addEventListener('click', ()=> toggleRun());
  restartBtn.addEventListener('click', ()=> {
    level = 1; score = 0; initCoinsForLevel(1); updateHUD(); if(!running){ running=true; playBtn.textContent='إيقاف'; last = performance.now(); requestAnimationFrame(loop); }
  });

  // بدء افتراضي على التشغيل
  updateHUD();
  // لا نبدأ تلقائياً حتى يضغط المستخدم (بعض المتصفحات تمنع التشغيل التلقائي), لكن نضع زر واضح.
})();
</script>
</body>
  </html>
